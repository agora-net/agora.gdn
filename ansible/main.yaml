---
- name: Create ansible user and give it sudo access
  hosts: all
  remote_user: root
  become: yes
  tags:
    - setup
    - ansible

  vars:
    ansible_username: ansible
    ansible_ssh_keys:
      - https://github.com/kisamoto.keys

  tasks:
    - name: Create ansible user
      ansible.builtin.user:
        name: "{{ ansible_username }}"
        shell: /bin/bash
        system: yes

    - name: Give ansible user no password sudo access for all users
      community.general.sudoers:
        name: "{{ ansible_username }}-sudo"
        user: "{{ ansible_username }}"
        state: present
        commands: ALL
        nopassword: yes
        validation: required
        runas: ALL

    - name: Install public SSH keys for GitHub user kisamoto for ansible user
      ansible.builtin.authorized_key:
        user: "{{ ansible_username }}"
        state: present
        key: "{{ item }}"
      with_items: "{{ ansible_ssh_keys }}"

- name: Harden SSH configuration
  hosts: all
  user: ansible
  become: yes
  tags:
    - setup
    - ssh
    - hardening

  roles:
    # This will disable the root user and password authentication
    - devsec.hardening.ssh_hardening

- name: Prepare and harden box
  hosts: all
  remote_user: ansible
  become: yes
  tags:
    - os
    - setup
    - hardening

  pre_tasks:
    - name: Update the packages cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - geerlingguy.swap # add some swap space
    - devsec.hardening.os_hardening # lock down the OS
    - alvistack.podman # install podman

  vars:
    os_auditd_admin_space_left_action: rotate
    os_auditd_disk_full_action: rotate
    os_auditd_max_log_file_action: rotate
    os_ignore_users: ["ansible"]
    # Create a swap space to prevent the server from running out of memory
    swap_file_size_mb: "4096"

  tasks:
    - name: Upgrade all installed packages
      ansible.builtin.apt:
        upgrade: dist
        force_apt_get: yes
        autoremove: yes

    - name: Enable automatic security updates
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present

    - name: Configure automatic updates
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";

- name: Ensure webserver installed and watching directory
  hosts: app_servers
  remote_user: ansible
  become: yes
  tags:
    - app
    - webserver

  vars:
    app_cloudflare_api_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38346139306238623238373536313333363439336236316634343134306265656663303735363363
      6135666164653836323935653731386431323164653131310a636563613762373463663264333431
      37613136653532663137623038613534333063343962323464643839623039643234633362306138
      3235376165643237380a396336313137653261376239623562343863613338663934636331386663
      63303661623530393032393737613638393930656135636166653639346565346234303534346662
      6562366462366666623338343063336461633666333762643833

  roles:
    - role: caddy_ansible.caddy_ansible
      caddy_config: |
        import sites-enabled/*

      caddy_config_update: true
      caddy_update: true
      caddy_packages:
        - github.com/caddy-dns/cloudflare
        - github.com/mholt/caddy-ratelimit
      caddy_setcap: true
      caddy_systemd_capabilities_enabled: true
      caddy_systemd_capabilities: "CAP_NET_BIND_SERVICE"
      caddy_environment_variables:
        CF_API_TOKEN: "{{ app_cloudflare_api_token }}"

  tasks:
    - name: Create sites-enabled directory
      ansible.builtin.file:
        path: /etc/caddy/sites-enabled
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Update Caddy service to run as root group
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/caddy.service
        regexp: "^Group="
        line: "Group=root"
        state: present
      notify:
        - systemctl daemon-reload

  handlers:
    - name: systemctl daemon-reload
      ansible.builtin.systemd_service:
        daemon_reload: yes

- name: Deploy Agora Application
  hosts: app_servers
  remote_user: ansible
  become: yes
  tags:
    - app
    - deploy
  vars:
    # app information
    app_name: agora
    app_user: agora
    app_group: www-data
    app_media_domain: media.agora.gdn
    app_static_domain: cdn.agora.gdn
    app_domains:
      - agora.gdn
      - www.agora.gdn
      - "{{ app_static_domain }}"
      # todo(kisamoto): add agorausermedia.com dns entries
      # - agorausermedia.com # Used for user uploaded media
    app_static_host: https://{{ app_static_domain }}/
    # management information
    lets_encrypt_email: ewan@agora.gdn
    # additional app configuration
    app_django_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      30316332666532343838333837643936333432623763333531303834303161306437656134343335
      6138623233613462353563636131313235303330633337360a323932373838616264656462303161
      62316537653335643532653263346638363165396263313531303464626366666165303331316561
      3034313737393863640a303535386466623735356164646532373638626261613263386231316239
      34663434373462376432656230333465623566373030646265363561633165636166373032346463
      37323365316536396337616237326631343365656262633633363261303762653761356163316165
      64316666383262363232643131646562353132623936313539376130613864323638366137313137
      62373366366236336362
    # where the app code is
    github_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34323039636330663565613138363163633438616637366165366232353363316138366463306363
      6165623631383739613663623637386162306233333433350a353032396433396266363464616635
      63663139633930643764636137313366646436383231633839363662626564316231653238336637
      3132386163393437640a353739353634626261393338343039383334303435666632383137373631
      34323965366564373439303330636462343834316166666437373838656130373138343636393630
      37303937643632646266633633633739653632643131363235323036356164323438386137363439
      61636262646532303363656537616231373736343562383961383630643462663565323736613139
      38366565306632353130306663663433623661623837623339366436646631616166326432363936
      3837
    app_image_registry: docker.io
    app_image: "{{ app_image_registry}}/kisamoto/tmp.agora.net"
    app_image_registry_username: kisamoto
    # docker.io access token
    app_image_registry_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      61656439303330623434393332363734333361383063613234363436313865383865393438646465
      6661333533643938333936643364656437636431393238630a326461646565633633333635363866
      62356666643739326531666165646362393666346130323233353835323266353734633364306434
      3039633765663439660a386239613734353239666134666432663935306462623862343933323662
      37346337663534313332656538653265383233303138393230303237626263393134343733663236
      3761353066623633373838333634343336386637303566396631
    app_image_tag: latest

  tasks:
    - name: Set the group ID as a string
      ansible.builtin.set_fact:
        effective_group_id: "{{ ansible_facts['effective_group_id'] | string }}"

    - name: Set variable for runtime directory
      ansible.builtin.set_fact:
        runtime_dir: "{{ ansible_facts['env']['XDG_RUNTIME_DIR'] | default('/run/user/' + effective_group_id) }}/{{ app_name }}"

    - name: Create bind mount for gunicorn socket
      ansible.builtin.file:
        path: "{{ runtime_dir }}"
        state: directory
        group: "root"
        recurse: yes
        mode: "u=rwx,g=rwx,o=r"

    - name: Add podman volumes for sqlite database and media files
      containers.podman.podman_volume:
        name: "{{ app_name }}_{{ item }}"
      with_items:
        - db
        - media

    - name: Log in to docker hub for podman
      containers.podman.podman_login:
        username: "{{ app_image_registry_username }}"
        password: "{{ app_image_registry_password }}"
        registry: "{{ app_image_registry }}"

    - name: Pull app docker image for use with podman
      containers.podman.podman_image:
        name: "{{ app_image }}"
        tag: "{{ app_image_tag }}"

    - name: Create podman secrets
      containers.podman.podman_secret:
        name: "{{ item.name }}"
        data: "{{ item.data }}"
      with_items:
        - name: DJANGO_SECRET_KEY
          data: "{{ app_django_secret_key }}"

    - name: Create podman container for application
      containers.podman.podman_container:
        name: "{{ app_name }}"
        generate_systemd:
          path: /etc/systemd/system
        group_add:
          - "{{ app_group }}"
          - root
        # todo(kisamoto): Setup health checks
        image: "{{ app_image }}:{{ app_image_tag }}"
        volumes:
          - "{{ app_name }}_db:/data/db"
          - "{{ app_name }}_media:/data/media"
          - "{{ runtime_dir }}:/run/gunicorn"
        env:
          DEBUG: "False"
          DB_DEFAULT_URL: "sqlite:////data/db/db.sqlite3"
          ALLOWED_HOSTS: "{{ (app_domains + [app_media_domain]) | join(',') }}"
          STATIC_HOST: "{{ app_static_host }}"
          LOG_LEVEL: WARNING
          EMAIL_BACKEND: "django.core.mail.backends.smtp.EmailBackend"
        secrets:
          - DJANGO_SECRET_KEY,type=env,target=SECRET_KEY
      notify: reload caddy

    - name: Copy caddy config to directory being watched
      ansible.builtin.template:
        src: templates/caddy/Caddyfile.j2
        dest: /etc/caddy/sites-enabled/{{ app_name }}
        owner: www-data
        group: www-data
        mode: "0644"
        validate: caddy validate --adapter caddyfile --config %s
      notify: reload caddy

  handlers:
    - name: reload caddy
      ansible.builtin.systemd:
        name: caddy
        state: reloaded

- name: Add Backups for application
  hosts: app_servers
  remote_user: ansible
  become: yes
  tags:
    - backup

  vars:
    # app information
    app_name: agora
    # TODO(kisamoto): Add the Borg repo
    borg_repo:
    borg_passphrase: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65333461306537383863336563666339313435313164356538313564343136616264646537323464
      3234623934663636663431323231663063353439353633660a336534363666656162316466633833
      32373537653466643731303866346564616138656136633133323430353337663164343465636664
      6165383364633539320a343135393039626532323465666332646165613664363764346238393366
      37666138373136346536356666643834363565323131626666303632636634383330626166356661
      6165343235633961663635613766333861653333396134343231

  tasks:
    - name: Install Borg and Borgmatic
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      with_items:
        - borgbackup
        - borgmatic

    - name: Create Borgmatic configuration directory
      ansible.builtin.file:
        path: /etc/borgmatic
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Create Borgmatic configuration file
      ansible.builtin.template:
        src: templates/borgmatic/config.yaml.j2
        dest: /etc/borgmatic/config.yaml
        owner: root
        group: root
        mode: "0644"
        validate: borgmatic config validate --config %s

    - name: Create Borgmatic systemd services
      ansible.builtin.template:
        src: templates/borgmatic/{{ item }}.j2
        dest: /etc/systemd/system/{{ item }}
        owner: root
        group: root
        mode: "0644"
        validate: systemd_analyze verify %s
      with_items:
        - borgmatic.timer
        - borgmatic.service

    - name: Initialize remote Borg repository
      ansible.builtin.command: borg init --encryption=repokey-blake2 {{ borg_repo }}

    - name: Enable and start Borgmatic services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - borgmatic.timer
        - borgmatic.service
