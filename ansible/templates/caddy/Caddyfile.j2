(cf_dns_https) {
    tls {{ lets_encrypt_email }} {
        dns cloudflare {env.CF_API_TOKEN}
        resolvers 1.1.1.1
    }
}

(media_file_server) {
    file_server /media/* {
		hide .git
		precompressed zstd br gzip
        root {{ app_media_dir }}
	}
}

{{ app_media_domain }} {
    import cf_dns_https

    import media_file_server
}

# Reverse proxy everything. Whitenoise will serve static files.
{{ app_domains | join(' ') }} {
    import cf_dns_https

    @{{ app_name }} path *

    import media_file_server
    
	reverse_proxy @{{ app_name }} {
		to unix/{{ runtime_dir }}/gunicorn.sock
	}
}
